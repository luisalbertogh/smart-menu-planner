# This workflow will run the Chef agent periodically and dump a proposed menu plan for the week.

name: Chef Workflow

on:
  # Manual workflow
  workflow_dispatch:

# Permissions for the workflow
permissions:
  contents: write  # To create branches and commit changes
  pull-requests: write  # To create pull requests

# Workflow jobs
jobs:
  # Prepare the menu plan
  cooking:
    # Run on GH hosted Ubuntu runner
    runs-on: ubuntu-latest

    # Environment variables
    env:
      # Token for Copilot
      COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}  # GitHub Copilot token
      # GitHub token for GH CLI commands. Using the default workflow token. 
      # Additionally, permissions in settings/actions/Workflow permissions must be enabled to allow GH actions to create PRs.
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
      # Copilot model to use
      COPILOT_MODEL: gpt-4.1

    # Steps of the job
    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

    # Setup Node.js environment for GH Copilot CLI installation in next steps
    - name: Setup Node.js
      uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6.1.0
      with:
        node-version: '>=22'

    # Install GH Copilot CLI
    - name: Install GitHub Copilot CLI
      run: npm i -g @github/copilot

    # Setup Git config
    - name: Setup and configs
      id: setup
      shell: bash
      run: |
        # Git setup
        echo "Setting up git config"
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"

        # Make hook scripts executable
        chmod +x scripts/hooks/*.sh

        # Today's date
        echo "DATE=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

    # Create feature branch
    - name: Create feature branch
      shell: bash
      run: |
        # Propagate errors and exit in case of failure
        set -euo pipefail

        # Tell Copilot to create a new feature branch
        echo "Creating feature branch"
        TIMESTAMP=$(date +%s%3N)
        git checkout -b feature/menu-plan-${{ steps.setup.outputs.DATE }}-$TIMESTAMP
        echo "New branch successfully created."

    # Get weekly menu plan and push changes to new feature branch if succeeded
    - name: Get weekly menu plan
      id: get_menu_plan
      shell: bash
      run: |
        # Propagate errors and exit in case of failure
        set -euo pipefail

        # Create directories if not existing
        mkdir -p recipes/${{ steps.setup.outputs.DATE }}
        
        # Tell Copilot to generate the weekly menu plan
        echo "Getting weekly menu plan"
        copilot --model=${{ env.COPILOT_MODEL }} --agent=chef --allow-tool 'write' --prompt "Provide a new menu plan, please"
        
        # Wait for file system to settle
        sleep 60s  

        # Validate plan
        GENERATED_PLAN=$(cat menu_plans/MENU_PLAN_${{ steps.setup.outputs.DATE }}.md)

        # Save plan or exit if failed
        if [[ "$GENERATED_PLAN" =~ "Weekly Menu Plan" ]]; then
          echo "Menu plan generated successfully. Pushing changes."

          # Save plan for further outputs
          echo "$GENERATED_PLAN" >> $GITHUB_STEP_SUMMARY
        else
          echo "Failed to generate menu plan. Exiting."
          exit 1
        fi

        # Print created files for debugging
        ls -la menu_plans/
        ls -la recipes/${{ steps.setup.outputs.DATE }}/

    # Upload Copilot logs as artifact
    - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
      # Always upload logs, even if previous steps failed
      if: always()
      with:
        name: copilot-logs
        path: ./logs/*.log
        if-no-files-found: ignore
        retention-days: 7

    # Push changes to remote repository
    - name: Push changes
      run: |
        # Propagate errors and exit in case of failure
        set -euo pipefail

        echo "Pushing changes to remote repository"
        git add .
        git commit -m "Add weekly menu plan"
        git push origin HEAD

    # Create Pull Request
    - name: Create Pull Request
      shell: bash
      run: |
        # Propagate errors and exit in case of failure
        set -euo pipefail

        # Create a Pull Request using GH CLI
        echo "Creating Pull Request"
        gh pr create --base main --title "Weekly Menu Plan" --body-file menu_plans/MENU_PLAN_${{ steps.setup.outputs.DATE }}.md
